{% extends 'base.html' %}
{% load static %}
{% load humanize %}
{% load currency_tags %}

{% block title %}Cuentas Pendientes - Tienda Naturista{% endblock %}

{% block content %}
<!-- ===== TARJETA DE BIENVENIDA ===== -->
<div class="welcome-card">
  <h2>Cuentas Pendientes</h2>
  <p>Gestión de ventas a crédito y abonos de clientes</p>
</div>

<!-- ===== RESUMEN DE TOTALES ===== -->
<div class="resumen-totales">
  <div class="tarjeta-total">
    <div class="icono-total">
      <i class="fas fa-clock"></i>
    </div>
    <div class="info-total">
      <h3 id="totalCuentas">{{ total_cuentas }}</h3>
      <p>Ventas Pendientes</p>
    </div>
  </div>

  <div class="tarjeta-total">
    <div class="icono-total">
      <i class="fas fa-money-bill-wave"></i>
    </div>
    <div class="info-total">
      <h3 id="totalSaldoBs">Bs {{ total_saldo_pendiente|formato_venezolano }}</h3>
      <p id="totalSaldoUsd">$ {{ total_saldo_pendiente_usd|formato_venezolano }}</p>
      <span>Saldo Total Pendiente</span>
    </div>
  </div>

  <div class="tarjeta-total">
    <div class="icono-total">
      <i class="fas fa-users"></i>
    </div>
    <div class="info-total">
      <h3 id="totalClientes">{{ total_clientes_deuda }}</h3>
      <p id="totalClientesSub">De {{ clientes_deuda_detallada|length }} clientes a crédito</p>
      <span>Clientes con Deuda</span>
    </div>
  </div>
</div>

<!-- ===== TOP 5 CLIENTES CON MAYOR DEUDA ===== -->
<div class="panel-deudas-clientes">
  <h3><i class="fas fa-chart-bar"></i> Top 5 Clientes con Mayor Deuda</h3>
  <div class="clientes-lista">
    {% for cliente_data in clientes_top_5 %}
    <div class="cliente-deuda-item">
      <div class="cliente-info">
        <strong>{{ cliente_data.cliente.nombre }} {{ cliente_data.cliente.apellido }}</strong>
        <small>{{ cliente_data.cliente.cedula }}</small>
      </div>
      <div class="deuda-info">
        <span class="deuda-total">Bs {{ cliente_data.deuda_total_bs|formato_venezolano }}</span>
        <br><small class="text-muted">$ {{ cliente_data.deuda_total_usd|formato_venezolano }}</small>
        <small>{{ cliente_data.ventas_pendientes }} venta{{ cliente_data.ventas_pendientes|pluralize }} pendiente{{ cliente_data.ventas_pendientes|pluralize }}</small>
      </div>
      <div class="acciones-cliente">
        <a href="{% url 'cuentas_pendientes:gestionar_abono_cliente' cliente_data.cliente.cedula %}"
          class="btn-action btn-abonar" title="Gestionar Abono">
          <i class="fas fa-money-bill"></i>
        </a>
      </div>
    </div>
    {% empty %}
    <div class="empty-state">
      <i class="fas fa-smile-beam"></i>
      <p>¡No hay clientes con deuda pendiente!</p>
    </div>
    {% endfor %}
  </div>
</div>

<!-- ===== CONTENEDOR PRINCIPAL ===== -->
<div class="productos-container">
  <div class="productos-main">

    <!-- ===== BARRA DE HERRAMIENTAS ===== -->
    <div class="productos-toolbar">
      <div class="filtros-container">
        <div class="search-box">
          <i class="fas fa-search"></i>
          <input type="text" id="searchInput" placeholder="Buscar por cliente o cédula...">
        </div>

        <div class="filtro-select">
          <select id="estadoPagoSelect">
            <option value="">Todos los clientes</option>
            <option value="alta">Deuda Alta (> 30 días)</option>
            <option value="media">Deuda Media (15-30 días)</option>
            <option value="baja">Deuda Baja (< 15 días)</option>
          </select>
        </div>

        <button class="btn btn-secondary" id="btnGenerarReporte">
          <i class="fas fa-file-pdf"></i> Generar Reporte
        </button>
      </div>

      <div class="toolbar-actions">
        <!-- Removed Registrar Abono button as requested -->
      </div>
    </div>

    <!-- ===== TABLA DE CLIENTES CON DEUDA ===== -->
    <div class="table-container">
      <table id="dataTable">
        <thead>
          <tr>
            <th>Cliente</th>
            <th>Ventas Pendientes</th>
            <th>Deuda Total</th>
            <th>Días desde 1ra Venta</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="tableBody">
          {% for cliente_data in clientes_deuda_detallada %}
          <tr data-cliente-id="{{ cliente_data.cliente.cedula }}"
            data-deuda="{{ cliente_data.deuda_total|formato_venezolano }}" data-dias="{{ cliente_data.dias_transcurridos }}">
            <td>
              <strong>{{ cliente_data.cliente.nombre }} {{ cliente_data.cliente.apellido }}</strong>
              <br><small>{{ cliente_data.cliente.cedula }}</small>
              <br><small>{{ cliente_data.cliente.telefono|default:"Sin teléfono" }}</small>
            </td>
            <td class="text-center">
              <span class="badge-dias">{{ cliente_data.ventas_pendientes }}</span>
            </td>
            <td class="text-right">
              <span class="text-danger deuda-total">Bs {{ cliente_data.deuda_total_bs|formato_venezolano }}</span>
              <br><small class="text-muted">$ {{ cliente_data.deuda_total_usd|formato_venezolano }}</small>
            </td>
            <td class="text-center">
              <span class="badge-dias {{ cliente_data.badge_class }}">
                {{ cliente_data.dias_transcurridos }} día{{ cliente_data.dias_transcurridos|pluralize }}
              </span>
            </td>
            <td class="actions">
              <div class="acciones-venta">
                <!-- Gestionar abono -->
                <a href="{% url 'cuentas_pendientes:gestionar_abono_cliente' cliente_data.cliente.cedula %}"
                  class="btn-action btn-abonar" title="Gestionar Abono">
                  <i class="fas fa-money-bill"></i>
                </a>
              </div>
            </td>
          </tr>
          {% empty %}
          <tr class="empty-row">
            <td colspan="5">
              <i class="fas fa-smile-beam"></i>
              <h3>¡No hay clientes que hayan comprado a crédito!</h3>
              <p>El historial de ventas a crédito está vacío.</p>
            </td>
          </tr>
          {% endfor %}
          <!-- Fila para mostrar cuando los filtros no devuelven resultados -->
          <tr class="empty-row-filter" style="display: none;">
            <td colspan="5">
              <div class="empty-state-container">
                <i class="fas fa-search"></i>
                <h3>No se encontraron resultados</h3>
                <p>No hay clientes que coincidan con tu búsqueda o los filtros aplicados.</p>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- ===== ABONOS RECIENTES (JERÁRQUICO) ===== -->
<div class="panel-abonos-recientes">
  <h3><i class="fas fa-history"></i> Abonos Recientes (Últimos 30 días)</h3>
  <div class="abonos-lista">
    {% for cliente_grupo in abonos_recientes %}
    <div class="cliente-grupo-card">
      <!-- Encabezado del Cliente -->
      <div class="cliente-header" onclick="toggleElement(this.nextElementSibling); toggleIcon(this.querySelector('.fa-chevron-right'))">
        <div class="cliente-header-info">
          <i class="fas fa-user-circle"></i>
          <div>
            <strong>{{ cliente_grupo.cliente.nombre }} {{ cliente_grupo.cliente.apellido }}</strong>
            <br><small>{{ cliente_grupo.cliente.cedula }}</small>
          </div>
        </div>
        <div class="cliente-header-total">
          <span class="text-success">Bs {{ cliente_grupo.total_bs|formato_venezolano }}</span>
          <br><small>{{ cliente_grupo.ventas_list|length }} venta{{ cliente_grupo.ventas_list|length|pluralize }}</small>
        </div>
        <div class="toggle-icon">
          <i class="fas fa-chevron-right"></i>
        </div>
      </div>

      <!-- Contenedor de Ventas del Cliente -->
      <div class="ventas-colapsable">
        {% for venta_grupo in cliente_grupo.ventas_list %}
        <div class="venta-grupo-container">
          <div class="venta-header" onclick="toggleElement(this.nextElementSibling); toggleIcon(this.querySelector('.fa-plus-square'))">
            <div class="venta-header-info">
              <i class="fas fa-shopping-cart"></i>
              <strong>Venta #{{ venta_grupo.id_venta }}</strong>
              <span>({{ venta_grupo.abonos|length }} pago{{ venta_grupo.abonos|length|pluralize }})</span>
            </div>
            <div class="venta-header-monto">
              <strong>Bs {{ venta_grupo.total_bs_venta|formato_venezolano }}</strong>
              <i class="far fa-plus-square"></i>
            </div>
          </div>

          <!-- Detalles de Abonos de la Venta -->
          <div class="abonos-detalles-tabla">
            <table>
              <thead>
                <tr>
                  <th>Hora</th>
                  <th>Método</th>
                  <th>Comprobante</th>
                  <th class="text-right">Monto</th>
                </tr>
              </thead>
              <tbody>
                {% for abono in venta_grupo.abonos %}
                <tr class="{% if abono.anulado %}anulado{% endif %}">
                  <td>{{ abono.Fecha_Abono|time:"H:i" }}</td>
                  <td>{{ abono.get_Metodo_Pago_display }}</td>
                  <td>{{ abono.Comprobante|default:"-" }}</td>
                  <td class="text-right text-success"><strong>Bs {{ abono.Monto_Abono_Bs|formato_venezolano }}</strong></td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
    {% empty %}
    <div class="empty-state">
      <i class="fas fa-coins"></i>
      <p>No hay abonos registrados en los últimos 30 días</p>
    </div>
    {% endfor %}
  </div>
</div>
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'cuentas_pendientes/css/menu_cuentas.css' %}">
<style>
  /* Estilos para Agrupación Jerárquica de Abonos */
  .cliente-grupo-card {
    background: white;
    border-radius: 12px;
    border: 1px solid var(--border);
    margin-bottom: 15px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.03);
    overflow: hidden;
  }
  .cliente-header {
    padding: 15px 20px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    cursor: pointer;
    background: #fdfdfd;
    transition: background 0.2s;
  }
  .cliente-header:hover {
    background: #f8f9fa;
  }
  .cliente-header-info {
    display: flex;
    align-items: center;
    gap: 15px;
  }
  .cliente-header-info i {
    font-size: 2rem;
    color: var(--primary);
  }
  .cliente-header-total {
    text-align: right;
    min-width: 150px;
  }
  .cliente-header-total strong {
    font-size: 1.1rem;
  }

  .ventas-colapsable {
    display: none;
    padding: 0 20px 15px 20px;
    background: #fff;
    border-top: 1px solid #eee;
  }
  .ventas-colapsable.active {
    display: block;
  }

  .venta-grupo-container {
    margin-top: 10px;
    border: 1px solid #edf2f7;
    border-radius: 8px;
    overflow: hidden;
  }
  .venta-header {
    background: #f7fafc;
    padding: 10px 15px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: pointer;
    font-size: 0.95rem;
  }
  .venta-header-info {
    display: flex;
    align-items: center;
    gap: 10px;
    color: #4a5568;
  }
  .venta-header-monto {
    display: flex;
    align-items: center;
    gap: 12px;
    color: var(--success);
  }

  .abonos-detalles-tabla {
    display: none;
    padding: 10px;
    background: white;
  }
  .abonos-detalles-tabla.active {
    display: block;
  }
  .abonos-detalles-tabla table {
    width: 100%;
    margin-bottom: 0;
    font-size: 0.85rem;
  }
  .abonos-detalles-tabla th {
    background: #f1f5f9;
    padding: 6px 10px;
    font-weight: 600;
  }
  .abonos-detalles-tabla td {
    padding: 8px 10px;
    border-bottom: 1px solid #f1f5f9;
  }
  .abonos-detalles-tabla tr.anulado {
    text-decoration: line-through;
    opacity: 0.6;
  }

  .toggle-icon i {
    transition: transform 0.3s;
    color: #a0aec0;
  }
  .toggle-icon i.fa-chevron-down {
    transform: rotate(180deg);
  }
  .fa-plus-square, .fa-minus-square {
    cursor: pointer;
    color: var(--primary);
  }
</style>
{% endblock %}

{% block extra_js %}
<script src="{% static 'cuentas_pendientes/js/menu_cuentas.js' %}"></script>
<script>
  function toggleElement(el) {
    if (el) {
      el.classList.toggle('active');
    }
  }

  function toggleIcon(icon) {
    if (icon) {
      if (icon.classList.contains('fa-chevron-right')) {
        icon.classList.remove('fa-chevron-right');
        icon.classList.add('fa-chevron-down');
      } else if (icon.classList.contains('fa-chevron-down')) {
        icon.classList.remove('fa-chevron-down');
        icon.classList.add('fa-chevron-right');
      } else if (icon.classList.contains('fa-plus-square')) {
        icon.classList.remove('fa-plus-square');
        icon.classList.add('fa-minus-square');
      } else if (icon.classList.contains('fa-minus-square')) {
        icon.classList.remove('fa-minus-square');
        icon.classList.add('fa-plus-square');
      }
    }
  }
</script>
{% endblock %}