{% extends 'base.html' %}
{% load static %}
{% load humanize %}
{% load currency_tags %}

{% block title %}Cierre de Caja - Tienda Naturista{% endblock %}

{% block content %}
<div class="welcome-card">
    <h2><i class="fas fa-cash-register me-2"></i>Cierre de Caja Diario</h2>
    <p>Conciliación de ventas del sistema vs. ingresos reales</p>
</div>

{% if messages %}
<div class="messages-container" style="display: none;" id="djangoMessages">
    {% for message in messages %}
    <div class="alert alert-{{ message.tags }}" data-message-tag="{{ message.tags }}">
        {{ message }}
    </div>
    {% endfor %}
</div>
{% endif %}

<div class="date-selector">
    <button type="button" class="date-nav-btn" id="btnPrevDate" title="Día anterior">
        <i class="fas fa-chevron-left"></i>
    </button>

    <div class="date-input-container">
        <h3><i class="far fa-calendar-alt me-2"></i></h3>
        <input type="date" id="fechaCierre" value="{{ fecha_str }}" max="{{ es_hoy|yesno:'now,'|date:'Y-m-d' }}">
    </div>

    <button type="button" class="date-nav-btn" id="btnNextDate" title="Día siguiente" {% if es_hoy %}disabled style="opacity: 0.5; cursor: default;" {% endif %}>
        <i class="fas fa-chevron-right"></i>
    </button>
</div>

<form method="post" id="cierreForm">
    {% csrf_token %}

    <div class="cierre-form-card">
        <div class="card-header">
            <h3>
                Detalle de Ingresos por Método de Pago
                {% if cierre_existente %}
                    {% if bloqueado %}
                    <span class="status-badge cerrado ms-2" style="background-color: #6c757d;"><i class="fas fa-lock me-1"></i>Finalizado</span>
                    {% else %}
                    <span class="status-badge cerrado ms-2"><i class="fas fa-check me-1"></i>Registrado</span>
                    {% endif %}
                {% else %}
                <span class="status-badge abierto ms-2"><i class="fas fa-pen me-1"></i>Abierto</span>
                {% endif %}
            </h3>
            <div class="header-actions">
                {% if cierre_existente %}
                <a href="{% url 'cierre_caja:ver_recibo_cierre' cierre_existente.ID_Cierre %}" class="btn btn-sm btn-outline-primary">
                    <i class="fas fa-file-invoice me-1"></i>Ver Recibo
                </a>
                {% endif %}
            </div>
        </div>

        <div class="card-body">
            <div class="table-responsive">
                <table class="cierre-table">
                    <thead>
                        <tr>
                            <th style="width: 25%">Método de Pago</th>
                            <th style="width: 25%">Sistema (Ventas)</th>
                            <th style="width: 25%">Real (Caja)</th>
                            <th style="width: 25%">Diferencia</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>
                                <i class="fas fa-money-bill-wave method-icon"></i> Efectivo Bolívares
                            </td>
                            <td>
                                <span class="amount-display amount-system" data-raw="{{ montos_sistema.efectivo_bs|stringformat:'.2f' }}">
                                    Bs {{ montos_sistema.efectivo_bs|formato_venezolano }}
                                </span>
                            </td>
                            <td>
                                <div class="amount-input-group">
                                    <span class="currency-symbol">Bs</span>
                                    <input type="text" name="real_efectivo_bs" class="amount-input" {% if bloqueado %}disabled{% endif %}
                                           value="{% if cierre_existente %}{{ cierre_existente.Real_Efectivo_Bs|formato_venezolano }}{% else %}0,00{% endif %}"
                                           autocomplete="off">
                                </div>
                            </td>
                            <td><span class="difference-display diff-neutral">0,00</span></td>
                        </tr>

                        <tr>
                            <td>
                                <i class="fas fa-dollar-sign method-icon"></i> Efectivo Dólares
                            </td>
                            <td>
                                <span class="amount-display amount-system" data-raw="{{ montos_sistema.efectivo_usd|stringformat:'.2f' }}">
                                    $ {{ montos_sistema.efectivo_usd|formato_venezolano }}
                                </span>
                            </td>
                            <td>
                                <div class="amount-input-group">
                                    <span class="currency-symbol">$</span>
                                    <input type="text" name="real_efectivo_usd" class="amount-input" {% if bloqueado %}disabled{% endif %}
                                           value="{% if cierre_existente %}{{ cierre_existente.Real_Efectivo_USD|formato_venezolano }}{% else %}0,00{% endif %}"
                                           autocomplete="off">
                                </div>
                            </td>
                            <td><span class="difference-display diff-neutral">0,00</span></td>
                        </tr>

                        <tr>
                            <td>
                                <i class="fas fa-credit-card method-icon"></i> Punto de Venta
                            </td>
                            <td>
                                <span class="amount-display amount-system" data-raw="{{ montos_sistema.punto_venta|stringformat:'.2f' }}">
                                    Bs {{ montos_sistema.punto_venta|formato_venezolano }}
                                </span>
                            </td>
                            <td>
                                <div class="amount-input-group">
                                    <span class="currency-symbol">Bs</span>
                                    <input type="text" name="real_punto_venta" class="amount-input" {% if bloqueado %}disabled{% endif %}
                                           value="{% if cierre_existente %}{{ cierre_existente.Real_Punto_Venta|formato_venezolano }}{% else %}0,00{% endif %}"
                                           autocomplete="off">
                                </div>
                            </td>
                            <td><span class="difference-display diff-neutral">0,00</span></td>
                        </tr>

                        <tr>
                            <td>
                                <i class="fas fa-mobile-alt method-icon"></i> Pago Móvil
                            </td>
                            <td>
                                <span class="amount-display amount-system" data-raw="{{ montos_sistema.pago_movil|stringformat:'.2f' }}">
                                    Bs {{ montos_sistema.pago_movil|formato_venezolano }}
                                </span>
                            </td>
                            <td>
                                <div class="amount-input-group">
                                    <span class="currency-symbol">Bs</span>
                                    <input type="text" name="real_pago_movil" class="amount-input" {% if bloqueado %}disabled{% endif %}
                                           value="{% if cierre_existente %}{{ cierre_existente.Real_Pago_Movil|formato_venezolano }}{% else %}0,00{% endif %}"
                                           autocomplete="off">
                                </div>
                            </td>
                            <td><span class="difference-display diff-neutral">0,00</span></td>
                        </tr>

                        <tr>
                            <td>
                                <i class="fas fa-university method-icon"></i> Transferencia
                            </td>
                            <td>
                                <span class="amount-display amount-system" data-raw="{{ montos_sistema.transferencia|stringformat:'.2f' }}">
                                    Bs {{ montos_sistema.transferencia|formato_venezolano }}
                                </span>
                            </td>
                            <td>
                                <div class="amount-input-group">
                                    <span class="currency-symbol">Bs</span>
                                    <input type="text" name="real_transferencia" class="amount-input" {% if bloqueado %}disabled{% endif %}
                                           value="{% if cierre_existente %}{{ cierre_existente.Real_Transferencia|formato_venezolano }}{% else %}0,00{% endif %}"
                                           autocomplete="off">
                                </div>
                            </td>
                            <td><span class="difference-display diff-neutral">0,00</span></td>
                        </tr>

                        <tr>
                            <td>
                                <i class="far fa-credit-card method-icon"></i> Otros / Tarjeta
                            </td>
                            <td>
                                <span class="amount-display amount-system" data-raw="{{ montos_sistema.tarjeta|stringformat:'.2f' }}">
                                    Bs {{ montos_sistema.tarjeta|formato_venezolano }}
                                </span>
                            </td>
                            <td>
                                <div class="amount-input-group">
                                    <span class="currency-symbol">Bs</span>
                                    <input type="text" name="real_tarjeta" class="amount-input" {% if bloqueado %}disabled{% endif %}
                                           value="{% if cierre_existente %}{{ cierre_existente.Real_Tarjeta|formato_venezolano }}{% else %}0,00{% endif %}"
                                           autocomplete="off">
                                </div>
                            </td>
                            <td><span class="difference-display diff-neutral">0,00</span></td>
                        </tr>

                        <tr class="total-row">
                            <td>TOTAL GENERAL</td>
                            <td>
                                <div class="total-stacked">
                                    <div id="totalSystemBs">Bs 0,00</div>
                                    <div id="totalSystemUsd">$ 0,00</div>
                                </div>
                            </td>
                            <td>
                                <div class="total-stacked">
                                    <div id="totalRealBs">Bs 0,00</div>
                                    <div id="totalRealUsd">$ 0,00</div>
                                </div>
                            </td>
                            <td>
                                <div class="total-stacked">
                                    <div id="totalDiffBs" class="difference-display diff-neutral">Bs 0,00</div>
                                    <div id="totalDiffUsd" class="difference-display diff-neutral">$ 0,00</div>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="notes-section">
                <label for="notas"><i class="fas fa-sticky-note me-2"></i>Notas / Observaciones:</label>
                <textarea name="notas" id="notas" class="notes-input" {% if bloqueado %}disabled{% endif %}
                    placeholder="Ingrese cualquier observación sobre el cierre de caja...">{% if cierre_existente %}{{ cierre_existente.Notas }}{% endif %}</textarea>
            </div>

            <div class="form-actions">
                <a href="{% url 'cierre_caja:historial_cierres' %}" class="btn-print" style="margin-right: auto; background: #6c757d;">
                    <i class="fas fa-history"></i> Historial
                </a>

                {% if bloqueado %}
                <div class="alert alert-secondary mb-0" style="padding: 0.5rem 1rem;">
                    <i class="fas fa-lock me-2"></i>Cierre Finalizado (Solo Lectura)
                </div>
                {% else %}
                <button type="submit" class="btn-save">
                    <i class="fas fa-save"></i>
                    {% if cierre_existente %}Actualizar Cierre{% else %}Guardar Cierre{% endif %}
                </button>
                {% endif %}
            </div>
        </div>
    </div>
</form>

<div id="successModal" class="modal-overlay">
    <div class="modal-success">
        <div class="modal-success-icon">
            <i class="fas fa-check-circle"></i>
        </div>
        <h2 id="successModalTitle">¡Éxito!</h2>
        <p id="successModalMessage">La acción se ha realizado correctamente.</p>
        <button id="closeSuccessModal" class="btn-aceptar">Continuar</button>
    </div>
</div>

<div id="errorModal" class="modal-overlay">
    <div class="modal-error">
        <div class="modal-error-icon">
            <i class="fas fa-exclamation-circle"></i>
        </div>
        <h2 id="errorModalTitle">¡Error!</h2>
        <p id="errorModalMessage">Ha ocurrido un error inesperado.</p>
        <button id="closeErrorModal" class="btn-aceptar-error">Continuar</button>
    </div>
</div>

{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'cierre_caja/css/cierre_caja.css' %}">
{% endblock %}

{% block extra_js %}
<script src="{% static 'cierre_caja/js/cierre_caja.js' %}"></script>
{% endblock %}