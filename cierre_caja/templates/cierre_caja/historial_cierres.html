{% extends 'base.html' %}
{% load static %}
{% load currency_tags %}
{% load humanize %}

{% block title %}Historial de Cierres - Tienda Naturista{% endblock %}

{% block content %}
<div class="welcome-card">
    <h2><i class="fas fa-history me-2"></i>Historial de Cierres</h2>
    <p>Registro histórico de cierres de caja diarios</p>
</div>

<div class="productos-container">
    <div class="productos-main">

        <div class="productos-toolbar">
            <div class="filtros-container">
                <form method="get" id="filterForm" style="display: flex; gap: 15px; width: 100%;">
                    <input type="hidden" name="fecha_desde" id="inputFechaDesde" value="{{ fecha_desde|default:'' }}">
                    <input type="hidden" name="fecha_hasta" id="inputFechaHasta" value="{{ fecha_hasta|default:'' }}">

                    <button type="button"
                        class="btn-filtro-fecha {% if fecha_desde or fecha_hasta %}filtro-activo{% endif %}"
                        id="btnFiltroFecha" style="width: 175px; justify-content: center;">
                        <i class="fas fa-calendar-day"></i>
                        {% if fecha_desde_obj or fecha_hasta_obj %}
                        {{ fecha_desde_obj|date:"d/m" }} - {{ fecha_hasta_obj|date:"d/m" }}
                        {% else %}
                        Filtrar por Fecha
                        {% endif %}
                    </button>

                    <select name="estado" class="form-select" onchange="this.form.submit()"
                        style="width: 175px; padding: 10px 15px; border-radius: 50px; border: 2px solid var(--border-gray); background: white; color: var(--dark-gray); cursor: pointer; font-family: inherit; font-size: 0.95rem; font-weight: 500;">
                        <option value="">Todos los Estados</option>
                        <option value="completo" {% if estado == 'completo' %}selected{% endif %}>Cuadre Exacto</option>
                        <option value="sobra" {% if estado == 'sobra' %}selected{% endif %}>Sobra Dinero</option>
                        <option value="falta" {% if estado == 'falta' %}selected{% endif %}>Falta Dinero</option>
                    </select>

                    <a href="{% url 'cierre_caja:historial_cierres' %}" class="btn btn-secondary">
                        <i class="fas fa-sync-alt"></i> Limpiar
                    </a>

                    <a href="{% url 'cierre_caja:generar_reporte_cierres' %}?fecha_desde={{ fecha_desde|default:'' }}&fecha_hasta={{ fecha_hasta|default:'' }}&estado={{ estado|default:'' }}"
                        class="btn btn-secondary" target="_blank" title="Generar Reporte PDF">
                        <i class="fas fa-file-pdf"></i> Reporte
                    </a>
                </form>
            </div>

            <div class="toolbar-actions">
                <a href="{% url 'cierre_caja:menu_cierre_caja' %}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> Volver
                </a>
                <a href="{% url 'cierre_caja:menu_cierre_caja' %}" class="btn btn-primary">
                    <i class="fas fa-plus-circle"></i> Nuevo Cierre
                </a>
            </div>
        </div>

        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Fecha</th>
                        <th>Usuario</th>
                        <th style="text-align: right;">Total Sistema</th>
                        <th style="text-align: right;">Total Real</th>
                        <th style="text-align: center;">Diferencia</th>
                        <th style="text-align: center;">Notas</th>
                        <th style="text-align: center;">Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for cierre in cierres %}
                    <tr>
                        <td style="font-weight: 600;">
                            {{ cierre.Fecha_Cierre|date:'d/m/Y' }}
                        </td>
                        <td>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                {% with rol=cierre.Usuario.groups.all.0.name %}
                                {% if rol == 'Dueño' %}
                                <div style="width: 32px; height: 32px; background: #e74c3c; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 0.9rem;"
                                    title="Dueño">
                                    D
                                </div>
                                {% elif rol == 'Administrador' %}
                                <div style="width: 32px; height: 32px; background: #3498db; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 0.9rem;"
                                    title="Administrador">
                                    A
                                </div>
                                {% elif rol == 'Cajero' %}
                                <div style="width: 32px; height: 32px; background: #17a2b8; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 0.9rem;"
                                    title="Cajero">
                                    C
                                </div>
                                {% else %}
                                <div
                                    style="width: 32px; height: 32px; background: var(--primary-green); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 0.9rem;">
                                    {{ cierre.Usuario.username|first|upper }}
                                </div>
                                {% endif %}
                                {% endwith %}
                                {{ cierre.Usuario.username }}
                            </div>
                        </td>
                        <td
                            style="text-align: right; font-family: 'Roboto Mono', monospace; color: var(--natural-gray);">
                            <div>Bs {{ cierre.total_sistema_bs|formato_venezolano }}</div>
                            <div class="text-muted small">Ref {{ cierre.total_sistema_usd|formato_venezolano }}</div>
                        </td>
                        <td
                            style="text-align: right; font-family: 'Roboto Mono', monospace; color: var(--natural-gray);">
                            <div>Bs {{ cierre.total_real_bs|formato_venezolano }}</div>
                            <div class="text-muted small">Ref {{ cierre.total_real_usd|formato_venezolano }}</div>
                        </td>

                        <td style="text-align: center; font-family: 'Roboto Mono', monospace;">
                            <div class="mb-1">
                                {% if cierre.diferencia_bs > 0 %}
                                <span class="text-primary fw-bold">
                                    Bs +{{ cierre.diferencia_bs|formato_venezolano }}
                                </span>
                                {% elif cierre.diferencia_bs < 0 %} <span class="text-danger fw-bold">
                                    Bs {{ cierre.diferencia_bs|formato_venezolano }}
                                    </span>
                                    {% else %}
                                    <span class="text-success fw-bold">
                                        Bs {{ cierre.diferencia_bs|formato_venezolano }}
                                    </span>
                                    {% endif %}
                            </div>

                            <div class="small">
                                {% if cierre.diferencia_usd > 0 %}
                                <span class="text-primary fw-bold">
                                    Ref +{{ cierre.diferencia_usd|formato_venezolano }}
                                </span>
                                {% elif cierre.diferencia_usd < 0 %} <span class="text-danger fw-bold">
                                    Ref {{ cierre.diferencia_usd|formato_venezolano }}
                                    </span>
                                    {% else %}
                                    <span class="text-success fw-bold">
                                        Ref {{ cierre.diferencia_usd|formato_venezolano }}
                                    </span>
                                    {% endif %}
                            </div>
                        </td>
                        <td style="text-align: center;">
                            {% if cierre.Notas %}
                            <button class="btn-ver-nota" data-nota="{{ cierre.Notas }}"
                                style="background: none; border: none; color: var(--primary-blue); cursor: pointer; font-size: 1.1rem;"
                                title="Ver nota completa">
                                <i class="fas fa-comment-alt"></i>
                            </button>
                            {% else %}
                            <span style="color: var(--natural-gray);">-</span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="actions">
                                <a href="{% url 'cierre_caja:ver_recibo_cierre' cierre.ID_Cierre %}"
                                    class="btn-action btn-editar" title="Ver detalle">
                                    <i class="fas fa-eye"></i>
                                </a>
                                <a href="{% url 'cierre_caja:descargar_recibo_cierre' cierre.ID_Cierre %}"
                                    class="btn-action btn-edit-precio" title="Descargar PDF">
                                    <i class="fas fa-download"></i>
                                </a>
                                <a href="{% url 'cierre_caja:menu_cierre_caja' %}?fecha={{ cierre.Fecha_Cierre|date:'Y-m-d' }}"
                                    class="btn-action btn-cambiar-estado" title="Editar">
                                    <i class="fas fa-pen"></i>
                                </a>
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr class="empty-row">
                        <td colspan="7">
                            <div class="no-results">
                                <i class="fas fa-folder-open"></i>
                                <h3>No se encontraron cierres de caja</h3>
                                <p>No hay registros para el período seleccionado</p>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<div id="modalFiltroFechas" class="modal-filtro">
    <div class="modal-contenido">
        <div class="modal-header">
            <h3>Filtrar por Fecha</h3>
            <button class="btn-cerrar" id="btnCerrarModalFiltro">&times;</button>
        </div>
        <div class="modal-body">
            <div class="fecha-inputs">
                <div class="fecha-group">
                    <label for="fechaDesde">Desde:</label>
                    <input type="date" id="fechaDesde">
                </div>
                <div class="fecha-group">
                    <label for="fechaHasta">Hasta:</label>
                    <input type="date" id="fechaHasta">
                </div>
            </div>
            <div id="fechaError" class="error-message" style="display: none;">
                <i class="fas fa-exclamation-triangle"></i> La fecha "Hasta" no puede ser menor que la fecha "Desde"
            </div>
            <div class="opciones-rapidas">
                <h4>Opciones Rápidas:</h4>
                <div class="botones-opciones">
                    <button type="button" class="btn-opcion" data-dias="1">Hoy</button>
                    <button type="button" class="btn-opcion" data-dias="8">Última semana</button>
                    <button type="button" class="btn-opcion" data-dias="31">Último mes</button>
                    <button type="button" class="btn-opcion" data-dias="365">Último año</button>
                    <button type="button" class="btn-opcion btn-limpiar">Limpiar Fechas</button>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" id="btnCancelarFiltro">Cancelar</button>
            <button class="btn btn-primary" id="btnAplicarFiltro">Aplicar Filtro</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'productos/css/productos.css' %}">
<link rel="stylesheet" href="{% static 'cierre_caja/css/cierre_caja.css' %}?v=2.0">
<style>
    .no-results {
        text-align: center;
        padding: 60px 40px;
        color: var(--natural-gray);
    }

    .no-results i {
        font-size: 4rem;
        margin-bottom: 20px;
        color: var(--border-gray);
        opacity: 0.6;
    }

    .no-results h3 {
        font-weight: 500;
        margin-bottom: 10px;
        color: var(--dark-gray);
    }

    .no-results p {
        color: var(--natural-gray);
        font-size: 1rem;
    }
</style>
<div id="modalVerNota" class="modal-overlay">
    <div class="modal-contenido">
        <div class="modal-header">
            <h3>Nota del Cierre</h3>
            <button class="btn-cerrar" id="btnCerrarModalNota">&times;</button>
        </div>
        <div class="modal-body">
            <div class="nota-content"
                style="padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid var(--primary-blue);">
                <p id="contenidoNota"
                    style="margin: 0; color: var(--dark-gray); font-size: 1.1rem; line-height: 1.5; white-space: pre-wrap;">
                </p>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" id="btnCerrarNotaFooter">Cerrar</button>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // --- LÓGICA DEL FILTRO DE FECHAS ---
        const btnFiltroFecha = document.getElementById('btnFiltroFecha');
        const modalFiltroFechas = document.getElementById('modalFiltroFechas');
        const btnCerrarModalFiltro = document.getElementById('btnCerrarModalFiltro');
        const btnCancelarFiltro = document.getElementById('btnCancelarFiltro');
        const btnAplicarFiltro = document.getElementById('btnAplicarFiltro');

        const fechaDesdeInput = document.getElementById('fechaDesde');
        const fechaHastaInput = document.getElementById('fechaHasta');
        const fechaError = document.getElementById('fechaError');

        const inputHiddenDesde = document.getElementById('inputFechaDesde');
        const inputHiddenHasta = document.getElementById('inputFechaHasta');
        const filterForm = document.getElementById('filterForm');

        // Valores actuales
        let fechaDesdeVal = inputHiddenDesde.value;
        let fechaHastaVal = inputHiddenHasta.value;

        // Abrir Modal
        btnFiltroFecha.addEventListener('click', function () {
            fechaDesdeInput.value = fechaDesdeVal;
            fechaHastaInput.value = fechaHastaVal;
            validarFechas();
            modalFiltroFechas.style.display = 'flex';
        });

        // Cerrar Modal
        function cerrarModalFiltro() {
            modalFiltroFechas.style.display = 'none';
        }

        if (btnCerrarModalFiltro) btnCerrarModalFiltro.addEventListener('click', cerrarModalFiltro);
        if (btnCancelarFiltro) btnCancelarFiltro.addEventListener('click', cerrarModalFiltro);

        window.addEventListener('click', function (e) {
            if (e.target == modalFiltroFechas) {
                cerrarModalFiltro();
            }
        });

        // Opciones Rápidas
        document.querySelectorAll('.btn-opcion').forEach(btn => {
            btn.addEventListener('click', function () {
                if (this.classList.contains('btn-limpiar')) {
                    fechaDesdeInput.value = '';
                    fechaHastaInput.value = '';
                } else {
                    const dias = parseInt(this.dataset.dias);
                    const hoy = new Date();
                    const fin = new Date();
                    const inicio = new Date();

                    if (dias === 1) {
                        // Hoy
                        fechaDesdeInput.value = formatDate(hoy);
                        fechaHastaInput.value = formatDate(hoy);
                    } else {
                        inicio.setDate(hoy.getDate() - (dias - 1));
                        fechaDesdeInput.value = formatDate(inicio);
                        fechaHastaInput.value = formatDate(fin);
                    }
                }
                validarFechas();
            });
        });

        function formatDate(date) {
            const d = new Date(date);
            let month = '' + (d.getMonth() + 1);
            let day = '' + d.getDate();
            const year = d.getFullYear();

            if (month.length < 2) month = '0' + month;
            if (day.length < 2) day = '0' + day;

            return [year, month, day].join('-');
        }

        // Validación y sincronización min/max
        function validarFechas() {
            const desde = fechaDesdeInput.value;
            const hasta = fechaHastaInput.value;

            // Sincronizar restricciones min/max para grises en el calendario
            if (desde) {
                fechaHastaInput.setAttribute('min', desde);
            } else {
                fechaHastaInput.removeAttribute('min');
            }

            if (hasta) {
                fechaDesdeInput.setAttribute('max', hasta);
            } else {
                fechaDesdeInput.removeAttribute('max');
            }

            if (desde && hasta && desde > hasta) {
                fechaError.style.display = 'block';
                btnAplicarFiltro.disabled = true;
                btnAplicarFiltro.style.opacity = '0.5';
            } else {
                fechaError.style.display = 'none';
                btnAplicarFiltro.disabled = false;
                btnAplicarFiltro.style.opacity = '1';
            }
        }

        fechaDesdeInput.addEventListener('change', validarFechas);
        fechaHastaInput.addEventListener('change', validarFechas);

        // Aplicar Filtro
        btnAplicarFiltro.addEventListener('click', function () {
            inputHiddenDesde.value = fechaDesdeInput.value;
            inputHiddenHasta.value = fechaHastaInput.value;
            filterForm.submit();
        });

        // --- FIN LÓGICA FILTRO ---


        // Modal Ver Nota
        const modalVerNota = document.getElementById('modalVerNota');
        const btnCerrarModalNota = document.getElementById('btnCerrarModalNota');
        const btnCerrarNotaFooter = document.getElementById('btnCerrarNotaFooter');
        const contenidoNota = document.getElementById('contenidoNota');

        function abrirModalNota(texto) {
            contenidoNota.textContent = texto;
            modalVerNota.classList.add('active');
        }

        function cerrarModalNota() {
            modalVerNota.classList.remove('active');
        }

        // Event delegation para botones de nota
        document.addEventListener('click', function (e) {
            const btnNota = e.target.closest('.btn-ver-nota');
            if (btnNota) {
                const nota = btnNota.getAttribute('data-nota');
                abrirModalNota(nota);
            }
        });

        if (btnCerrarModalNota) {
            btnCerrarModalNota.addEventListener('click', cerrarModalNota);
        }

        if (btnCerrarNotaFooter) {
            btnCerrarNotaFooter.addEventListener('click', cerrarModalNota);
        }

        if (modalVerNota) {
            modalVerNota.addEventListener('click', function (e) {
                if (e.target === this) {
                    cerrarModalNota();
                }
            });
        }
    });
</script>
{% endblock %}