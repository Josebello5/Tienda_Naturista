{% extends 'base.html' %}
{% load static %}

{% block title %}Historial de Cierres - Tienda Naturista{% endblock %}

{% block content %}
<!-- ===== TARJETA DE BIENVENIDA ===== -->
<div class="welcome-card">
    <h2><i class="fas fa-history me-2"></i>Historial de Cierres</h2>
    <p>Registro histórico de cierres de caja diarios</p>
</div>

<!-- ===== CONTENEDOR PRINCIPAL ===== -->
<div class="productos-container">
    <div class="productos-main">

        <!-- ===== BARRA DE HERRAMIENTAS ===== -->
        <div class="productos-toolbar">
            <div class="filtros-container">
                <form method="get" style="display: flex; gap: 15px; width: 100%;">
                    <div class="filtro-select" style="flex: 1;">
                        <input type="date" name="fecha_desde" value="{{ fecha_desde|default:'' }}"
                            style="width: 100%; padding: 14px 18px; border: 2px solid var(--border-gray); border-radius: 50px; font-size: 1rem;">
                    </div>
                    <div class="filtro-select" style="flex: 1;">
                        <input type="date" name="fecha_hasta" value="{{ fecha_hasta|default:'' }}"
                            style="width: 100%; padding: 14px 18px; border: 2px solid var(--border-gray); border-radius: 50px; font-size: 1rem;">
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-filter"></i> Filtrar
                    </button>
                    <a href="{% url 'cierre_caja:historial_cierres' %}" class="btn btn-secondary">
                        <i class="fas fa-sync-alt"></i> Limpiar
                    </a>
                </form>
            </div>

            <div class="toolbar-actions">
                <a href="{% url 'cierre_caja:menu_cierre_caja' %}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> Volver
                </a>
                <a href="{% url 'cierre_caja:menu_cierre_caja' %}" class="btn btn-primary">
                    <i class="fas fa-plus-circle"></i> Nuevo Cierre
                </a>
            </div>
        </div>

        <!-- ===== TABLA DE HISTORIAL ===== -->
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Fecha</th>
                        <th>Usuario</th>
                        <th style="text-align: right;">Total Sistema (Ref)</th>
                        <th style="text-align: right;">Total Real (Ref)</th>
                        <th style="text-align: center;">Diferencia</th>
                        <th style="text-align: center;">Notas</th>
                        <th style="text-align: center;">Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for cierre in cierres %}
                    <tr>
                        <td style="font-weight: 600;">
                            {{ cierre.Fecha_Cierre|date:'d/m/Y' }}
                        </td>
                        <td>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <div
                                    style="width: 32px; height: 32px; background: var(--primary-green); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 0.9rem;">
                                    {{ cierre.Usuario.username|first|upper }}
                                </div>
                                {{ cierre.Usuario.username }}
                            </div>
                        </td>
                        <td
                            style="text-align: right; font-family: 'Roboto Mono', monospace; color: var(--natural-gray);">
                            {{ cierre.Total_Sistema|floatformat:2 }}
                        </td>
                        <td style="text-align: right; font-family: 'Roboto Mono', monospace; font-weight: 600;">
                            {{ cierre.Total_Real|floatformat:2 }}
                        </td>
                        <td style="text-align: center;">
                            {% if cierre.Diferencia_Total == 0 %}
                            <span class="status status-active">Cuadre Exacto</span>
                            {% elif cierre.Diferencia_Total > 0 %}
                            <span class="status diff-positive">+{{ cierre.Diferencia_Total|floatformat:2 }}
                                (Sobra)</span>
                            {% else %}
                            <span class="status diff-negative">{{ cierre.Diferencia_Total|floatformat:2 }}
                                (Falta)</span>
                            {% endif %}
                        </td>
                        <td style="text-align: center;">
                            {% if cierre.Notas %}
                            <button class="btn-ver-nota" data-nota="{{ cierre.Notas }}"
                                style="background: none; border: none; color: var(--primary-blue); cursor: pointer; font-size: 1.1rem;"
                                title="Ver nota completa">
                                <i class="fas fa-comment-alt"></i>
                            </button>
                            {% else %}
                            <span style="color: var(--natural-gray);">-</span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="actions">
                                <a href="{% url 'cierre_caja:ver_recibo_cierre' cierre.ID_Cierre %}"
                                    class="btn-action btn-editar" title="Ver detalle">
                                    <i class="fas fa-eye"></i>
                                </a>
                                <a href="{% url 'cierre_caja:descargar_recibo_cierre' cierre.ID_Cierre %}"
                                    class="btn-action btn-edit-precio" title="Descargar PDF">
                                    <i class="fas fa-download"></i>
                                </a>
                                <a href="{% url 'cierre_caja:menu_cierre_caja' %}?fecha={{ cierre.Fecha_Cierre|date:'Y-m-d' }}"
                                    class="btn-action btn-cambiar-estado" title="Editar">
                                    <i class="fas fa-pen"></i>
                                </a>
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr class="empty-row">
                        <td colspan="7">
                            <div class="no-results">
                                <i class="fas fa-folder-open"></i>
                                <h3>No se encontraron cierres de caja</h3>
                                <p>No hay registros para el período seleccionado</p>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'cierre_caja/css/cierre_caja.css' %}">
<link rel="stylesheet" href="{% static 'productos/css/productos.css' %}">
<style>
    .no-results {
        text-align: center;
        padding: 60px 40px;
        color: var(--natural-gray);
    }

    .no-results i {
        font-size: 4rem;
        margin-bottom: 20px;
        color: var(--border-gray);
        opacity: 0.6;
    }

    .no-results h3 {
        font-weight: 500;
        margin-bottom: 10px;
        color: var(--dark-gray);
    }

    .no-results p {
        color: var(--natural-gray);
        font-size: 1rem;
    }
</style>
<!-- ===== MODAL VER NOTA ===== -->
<div id="modalVerNota" class="modal-overlay">
    <div class="modal-contenido">
        <div class="modal-header">
            <h3>Nota del Cierre</h3>
            <button class="btn-cerrar" id="btnCerrarModalNota">&times;</button>
        </div>
        <div class="modal-body">
            <div class="nota-content"
                style="padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid var(--primary-blue);">
                <p id="contenidoNota"
                    style="margin: 0; color: var(--dark-gray); font-size: 1.1rem; line-height: 1.5; white-space: pre-wrap;">
                </p>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" id="btnCerrarNotaFooter">Cerrar</button>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Modal Ver Nota
        const modalVerNota = document.getElementById('modalVerNota');
        const btnCerrarModalNota = document.getElementById('btnCerrarModalNota');
        const btnCerrarNotaFooter = document.getElementById('btnCerrarNotaFooter');
        const contenidoNota = document.getElementById('contenidoNota');

        function abrirModalNota(texto) {
            contenidoNota.textContent = texto;
            modalVerNota.classList.add('active');
        }

        function cerrarModalNota() {
            modalVerNota.classList.remove('active');
        }

        // Event delegation para botones de nota
        document.addEventListener('click', function (e) {
            const btnNota = e.target.closest('.btn-ver-nota');
            if (btnNota) {
                const nota = btnNota.getAttribute('data-nota');
                abrirModalNota(nota);
            }
        });

        if (btnCerrarModalNota) {
            btnCerrarModalNota.addEventListener('click', cerrarModalNota);
        }

        if (btnCerrarNotaFooter) {
            btnCerrarNotaFooter.addEventListener('click', cerrarModalNota);
        }

        if (modalVerNota) {
            modalVerNota.addEventListener('click', function (e) {
                if (e.target === this) {
                    cerrarModalNota();
                }
            });
        }
    });
</script>
{% endblock %}