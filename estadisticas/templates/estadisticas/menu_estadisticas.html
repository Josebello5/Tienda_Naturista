{% extends 'base.html' %}
{% load static %}

{% block title %}Estadísticas - Tienda Naturista{% endblock %}

{% block content %}
<div class="productos-container">
    <!-- ===== TARJETA DE BIENVENIDA ===== -->
    <div class="welcome-card">
        <h2><i class="fas fa-chart-line me-2"></i>Panel de Estadísticas</h2>
        <p>Visión general del rendimiento y estado del inventario</p>
    </div>

    <!-- ===== GRID DE PANELES ===== -->
    <div class="stats-grid">

        <!-- === PANEL 1: PRODUCTOS MÁS VENDIDOS === -->
        <div class="stats-card">
            <div class="card-header">
                <div>
                    <h3><i class="fas fa-box-open text-primary"></i> Top Productos</h3>
                    <span class="filter-info" id="info-prod">
                        Del {{ fecha_ini_prod|date:"d/m/Y" }} al {{ fecha_fin_prod|date:"d/m/Y" }}
                    </span>
                </div>
                <div class="card-actions">
                    <button class="btn-icon-card btn-filter-date" title="Filtrar Fechas" data-context="prod"
                        data-ini="{{ fecha_ini_prod|date:'Y-m-d' }}" data-fin="{{ fecha_fin_prod|date:'Y-m-d' }}"
                        data-type="past">
                        <i class="fas fa-filter"></i>
                    </button>
                    <!-- Agregamos target="_blank" para asegurar apertura y depuracion -->
                    <a href="{% url 'estadisticas:reporte_productos' %}?fecha_ini={{ fecha_ini_prod|date:'Y-m-d' }}&fecha_fin={{ fecha_fin_prod|date:'Y-m-d' }}"
                        class="btn-icon-card btn-print-prod" title="Descargar PDF" target="_blank">
                        <i class="fas fa-print"></i>
                    </a>
                </div>
            </div>
            <div class="card-body">
                <!-- Barra de búsqueda -->
                <div class="search-container">
                    <input type="text" class="search-input" id="search-prod" placeholder="Buscar producto..." value="{{ search_prod }}">
                    <i class="fas fa-search search-icon"></i>
                </div>
                <ul class="ranking-list" id="list-productos">
                    {% if top_productos %}
                    {% for item in top_productos %}
                    <li class="ranking-item">
                        <span class="rank-badge">{{ forloop.counter }}</span>
                        <div class="item-info">
                            <span class="item-name">{{ item.ID_lote__id_producto__nombre_pro }}</span>
                            <span class="item-meta">ID: {{ item.ID_lote__id_producto__ID_producto }}</span>
                        </div>
                        <div class="item-value">
                            {{ item.total_cantidad|floatformat:0 }} un.
                        </div>
                    </li>
                    {% endfor %}
                    {% else %}
                    <div class="empty-state text-center p-4">
                        <i class="fas fa-box-open fa-2x text-muted mb-2"></i>
                        <p class="text-muted">No hay ventas registradas en este período.</p>
                    </div>
                    {% endif %}
                </ul>
                <div id="no-prod" class="empty-row text-center p-4" style="display: none;">
                    <i class="fas fa-box-open fa-2x text-muted mb-2"></i>
                    <p class="text-muted">No hay ventas registradas en este período.</p>
                </div>
            </div>
        </div>

        <!-- === PANEL 2: CLIENTES FRECUENTES === -->
        <div class="stats-card">
            <div class="card-header">
                <div>
                    <h3><i class="fas fa-users text-primary"></i> Top Clientes</h3>
                    <span class="filter-info" id="info-cli">
                        Del {{ fecha_ini_cli|date:"d/m/Y" }} al {{ fecha_fin_cli|date:"d/m/Y" }}
                    </span>
                </div>
                <div class="card-actions">
                    <!-- Toggle de moneda -->
                    <button class="btn-icon-card btn-toggle-moneda" title="Cambiar Moneda" data-moneda="{{ moneda_cli }}">
                        <i class="fas fa-dollar-sign"></i>
                    </button>
                    <button class="btn-icon-card btn-filter-date" title="Filtrar Fechas" data-context="cli"
                        data-ini="{{ fecha_ini_cli|date:'Y-m-d' }}" data-fin="{{ fecha_fin_cli|date:'Y-m-d' }}"
                        data-type="past">
                        <i class="fas fa-filter"></i>
                    </button>
                    <a href="{% url 'estadisticas:reporte_clientes' %}?fecha_ini={{ fecha_ini_cli|date:'Y-m-d' }}&fecha_fin={{ fecha_fin_cli|date:'Y-m-d' }}"
                        class="btn-icon-card btn-print-cli" title="Descargar PDF" target="_blank">
                        <i class="fas fa-print"></i>
                    </a>
                </div>
            </div>
            <div class="card-body">
                <!-- Barra de búsqueda -->
                <div class="search-container">
                    <input type="text" class="search-input" id="search-cli" placeholder="Buscar cliente..." value="{{ search_cli }}">
                    <i class="fas fa-search search-icon"></i>
                </div>
                <ul class="ranking-list" id="list-clientes">
                    {% if top_clientes %}
                    {% for item in top_clientes %}
                    <li class="ranking-item">
                        <span class="rank-badge">{{ forloop.counter }}</span>
                        <div class="item-info">
                            <span class="item-name">{{ item.Cedula__nombre }} {{ item.Cedula__apellido }}</span>
                            <span class="item-meta">{{ item.Cedula__cedula }}</span>
                        </div>
                        <div class="text-end">
                            <div class="item-value" style="font-size: 0.9rem;">{{ item.total_compras }} compras</div>
                            <span class="item-meta" id="total-cli-{{ forloop.counter }}" data-bs="{{ item.total_gastado }}" data-usd="{{ item.total_gastado|floatformat:2 }}">{% if moneda_cli == 'usd' %}${% else %}Bs{% endif %} {{ item.total_gastado|floatformat:2 }}</span>
                        </div>
                    </li>
                    {% endfor %}
                    {% else %}
                    <div class="empty-state text-center p-4">
                        <i class="fas fa-users fa-2x text-muted mb-2"></i>
                        <p class="text-muted">No hay clientes registrados en este período.</p>
                    </div>
                    {% endif %}
                </ul>
                <div id="no-cli" class="empty-row text-center p-4" style="display: none;">
                    <i class="fas fa-users fa-2x text-muted mb-2"></i>
                    <p class="text-muted">No hay clientes registrados en este período.</p>
                </div>
            </div>
        </div>

        <!-- === PANEL 3: PRODUCTOS POR VENCER === -->
        <div class="stats-card">
            <div class="card-header">
                <div>
                    <h3><i class="fas fa-exclamation-triangle text-warning"></i> Por Vencer</h3>
                    <span class="filter-info" id="info-venc">
                        Del {{ fecha_ini_venc|date:"d/m/Y" }} al {{ fecha_fin_venc|date:"d/m/Y" }}
                    </span>
                </div>
                <div class="card-actions">
                    <button class="btn-icon-card btn-filter-date" title="Filtrar Fechas" data-context="venc"
                        data-ini="{{ fecha_ini_venc|date:'Y-m-d' }}" data-fin="{{ fecha_fin_venc|date:'Y-m-d' }}"
                        data-type="future">
                        <i class="fas fa-filter"></i>
                    </button>
                    <a href="{% url 'estadisticas:reporte_vencimiento' %}?fecha_ini={{ fecha_ini_venc|date:'Y-m-d' }}&fecha_fin={{ fecha_fin_venc|date:'Y-m-d' }}"
                        class="btn-icon-card btn-print-venc" title="Descargar PDF" target="_blank">
                        <i class="fas fa-print"></i>
                    </a>
                </div>
            </div>
            <div class="card-body">
                <!-- Barra de búsqueda -->
                <div class="search-container">
                    <input type="text" class="search-input" id="search-venc" placeholder="Buscar producto..." value="{{ search_venc }}">
                    <i class="fas fa-search search-icon"></i>
                </div>
                <ul class="ranking-list" id="list-vencimiento">
                    {% if lotes_por_vencer %}
                    {% for lote in lotes_por_vencer %}
                    <li class="ranking-item">
                        <div class="item-info">
                            <span class="item-name">{{ lote.id_producto.nombre_pro }}</span>
                            <span class="item-meta">Lote: {{ lote.codigo_lote }} | Disp: {{ lote.cantidad_disponible }}</span>
                        </div>
                        <div class="text-end">
                            <div class="item-value text-danger" style="color: var(--error-red);">{{ lote.fecha_vencimiento|date:"d/m/Y" }}</div>
                            <span class="item-meta">{{ lote.tiempo_restante }}</span>
                        </div>
                    </li>
                    {% endfor %}
                    {% else %}
                    <div class="empty-state text-center p-4">
                        <i class="fas fa-check-circle text-success fa-3x mb-3"></i>
                        <p class="text-muted">Todo en orden.<br>No hay productos por vencer en este rango.</p>
                    </div>
                    {% endif %}
                </ul>
                <div id="no-venc" class="empty-row text-center p-4" style="display: none;">
                    <i class="fas fa-check-circle text-success fa-3x mb-2"></i>
                    <p class="text-muted">Todo en orden.<br>No hay productos por vencer en este rango.</p>
                </div>
            </div>
        </div>

        <!-- === PANEL 4: TOP CATEGORÍAS === -->
        <div class="stats-card">
            <div class="card-header">
                <div>
                    <h3><i class="fas fa-layer-group text-primary"></i> Top Categorías</h3>
                    <span class="filter-info" id="info-cat">
                        Del {{ fecha_ini_cat|date:"d/m/Y" }} al {{ fecha_fin_cat|date:"d/m/Y" }}
                    </span>
                </div>
                <div class="card-actions">
                    <!-- Toggle de moneda -->
                    <button class="btn-icon-card btn-toggle-moneda-cat" title="Cambiar Moneda" data-moneda="{{ moneda_cat|default:'bs' }}">
                        <i class="fas fa-dollar-sign"></i>
                    </button>
                    <button class="btn-icon-card btn-filter-date" title="Filtrar Fechas" data-context="cat"
                        data-ini="{{ fecha_ini_cat|date:'Y-m-d' }}" data-fin="{{ fecha_fin_cat|date:'Y-m-d' }}"
                        data-type="past">
                        <i class="fas fa-filter"></i>
                    </button>
                    <a href="#" id="btn-print-categorias-panel" class="btn-icon-card" title="Descargar PDF" target="_blank">
                        <i class="fas fa-print"></i>
                    </a>
                </div>
            </div>
            <div class="card-body">
                <div class="search-container">
                    <input type="text" class="search-input" id="search-cat-panel" placeholder="Buscar categoría..." value="{{ search_cat }}">
                    <i class="fas fa-search search-icon"></i>
                </div>
                <ul class="ranking-list" id="list-categorias-panel">
                    {% if top_categorias %}
                    {% for item in top_categorias %}
                    <li class="ranking-item">
                        <span class="rank-badge">{{ forloop.counter }}</span>
                        <div class="item-info">
                            <span class="item-name">{{ item.ID_lote__id_producto__categoria__nombre }}</span>
                        </div>
                        <div class="text-end">
                            <div class="item-value" style="font-size: 0.9rem;">{{ item.total_cantidad|floatformat:0 }} un.</div>
                            <span class="item-meta">Bs {{ item.total_ventas|floatformat:2 }}</span>
                        </div>
                    </li>
                    {% endfor %}
                    {% else %}
                    <div class="empty-state text-center p-4">
                        <i class="fas fa-layer-group fa-2x text-muted mb-2"></i>
                        <p class="text-muted">No hay ventas registradas en este período.</p>
                    </div>
                    {% endif %}
                </ul>
                <div id="no-cat" class="empty-row text-center p-4" style="display: none;">
                    <i class="fas fa-layer-group fa-2x text-muted mb-2"></i>
                    <p class="text-muted">No hay ventas registradas en este período.</p>
                </div>
            </div>
        </div>

    </div>
</div>

<!-- ===== SECCIÓN DE GRÁFICOS ===== -->
<div class="charts-section">
    <div class="charts-header">
        <h2><i class="fas fa-chart-pie me-2"></i>Análisis Visual</h2>
        <p>Gráficos interactivos para análisis de tendencias</p>
    </div>
    
    <!-- Tabs para cambiar entre gráficos -->
    <div class="chart-tabs">
        <button class="chart-tab active" data-chart="ventas">
            <i class="fas fa-chart-line"></i> Ventas en el Tiempo
        </button>
        <button class="chart-tab" data-chart="productos">
            <i class="fas fa-chart-bar"></i> Top Productos
        </button>
        <button class="chart-tab" data-chart="categorias">
            <i class="fas fa-layer-group"></i> Por Categoría
        </button>
    </div>
    
    <!-- Contenedor: Ventas en el Tiempo -->
    <div class="chart-container active" id="chart-ventas">
        <div class="chart-controls">
            <div class="control-group">
                <label>Desde:</label>
                <input type="date" id="fecha-ini-ventas" class="chart-date">
            </div>
            <div class="control-group">
                <label>Hasta:</label>
                <input type="date" id="fecha-fin-ventas" class="chart-date">
            </div>
            <div class="quick-filters">
                <button class="btn-quick" data-target="ventas" data-range="hoy">Hoy</button>
                <button class="btn-quick" data-target="ventas" data-range="semana">Semana</button>
                <button class="btn-quick" data-target="ventas" data-range="mes">Mes</button>
                <button class="btn-quick" data-target="ventas" data-range="anio">Año</button>
            </div>
            <div class="control-group">
                <label>Período:</label>
                <select id="periodo-ventas" class="chart-select">
                    <option value="dia">Por Día</option>
                    <option value="semana">Por Semana</option>
                    <option value="mes" selected>Por Mes</option>
                </select>
            </div>
            <div class="control-group">
                <label>Moneda:</label>
                <button class="btn-toggle-chart" id="toggle-moneda-ventas" data-moneda="bs">
                    <i class="fas fa-dollar-sign"></i> <span>Bs</span>
                </button>
            </div>
            <button class="btn-apply-chart" id="apply-ventas">
                <i class="fas fa-sync-alt"></i> Actualizar
            </button>
            <a href="#" id="btn-print-ventas" target="_blank" class="btn-print-chart">
                <i class="fas fa-print"></i>
            </a>
        </div>
        <div class="chart-canvas-wrapper">
            <canvas id="canvas-ventas"></canvas>
        </div>
    </div>
    
    <!-- Contenedor: Top Productos -->
    <div class="chart-container" id="chart-productos">
        <div class="chart-controls">
            <div class="control-group">
                <label>Desde:</label>
                <input type="date" id="fecha-ini-productos" class="chart-date">
            </div>
            <div class="control-group">
                <label>Hasta:</label>
                <input type="date" id="fecha-fin-productos" class="chart-date">
            </div>
            <div class="quick-filters">
                <button class="btn-quick" data-target="productos" data-range="hoy">Hoy</button>
                <button class="btn-quick" data-target="productos" data-range="semana">Semana</button>
                <button class="btn-quick" data-target="productos" data-range="mes">Mes</button>
                <button class="btn-quick" data-target="productos" data-range="anio">Año</button>
            </div>
            <button class="btn-apply-chart" id="apply-productos">
                <i class="fas fa-sync-alt"></i> Actualizar
            </button>
            <a href="#" id="btn-print-productos" target="_blank" class="btn-print-chart">
                <i class="fas fa-print"></i>
            </a>
        </div>
        <div class="chart-canvas-wrapper">
            <canvas id="canvas-productos"></canvas>
        </div>
    </div>
    
    <!-- Contenedor: Ventas por Categoría -->
    <div class="chart-container" id="chart-categorias">
        <div class="chart-controls">
            <div class="control-group">
                <label>Desde:</label>
                <input type="date" id="fecha-ini-categorias" class="chart-date">
            </div>
            <div class="control-group">
                <label>Hasta:</label>
                <input type="date" id="fecha-fin-categorias" class="chart-date">
            </div>
            <div class="quick-filters">
                <button class="btn-quick" data-target="categorias" data-range="hoy">Hoy</button>
                <button class="btn-quick" data-target="categorias" data-range="semana">Semana</button>
                <button class="btn-quick" data-target="categorias" data-range="mes">Mes</button>
                <button class="btn-quick" data-target="categorias" data-range="anio">Año</button>
            </div>
            <div class="control-group">
                <label>Moneda:</label>
                <button class="btn-toggle-chart" id="toggle-moneda-categorias" data-moneda="bs">
                    <i class="fas fa-dollar-sign"></i> <span>Bs</span>
                </button>
            </div>
            <button class="btn-apply-chart" id="apply-categorias">
                <i class="fas fa-sync-alt"></i> Actualizar
            </button>
            <a href="#" id="btn-print-categorias" target="_blank" class="btn-print-chart">
                <i class="fas fa-print"></i>
            </a>
        </div>
        <div class="chart-canvas-wrapper">
            <canvas id="canvas-categorias"></canvas>
        </div>
    </div>
</div>

<!-- ===== MODAL FILTRO FECHAS (Estilo Lotes) ===== -->
<div id="modalFiltroFechas" class="modal-filtro">
    <div class="modal-contenido">
        <div class="modal-header">
            <h3 id="modalTitulo">Filtrar por Fechas</h3>
            <button class="btn-cerrar" id="btnCerrarModal">&times;</button>
        </div>
        <div class="modal-body">
            <div class="fecha-inputs">
                <div class="fecha-group">
                    <label for="fechaDesde">Desde:</label>
                    <input type="date" id="fechaDesde">
                </div>
                <div class="fecha-group">
                    <label for="fechaHasta">Hasta:</label>
                    <input type="date" id="fechaHasta">
                </div>
            </div>

            <!-- Mensaje de error para validación -->
            <div id="errorFechas" class="error-message" style="display: none; margin-bottom: 15px;">
                <i class="fas fa-exclamation-circle"></i> <span>La fecha final debe ser mayor que la inicial</span>
            </div>

            <div class="opciones-rapidas">
                <h4>Opciones rápidas:</h4>
                <div class="botones-opciones" id="opcionesPasado">
                    <button type="button" class="btn-opcion" data-dias="7">Últimos 7 días</button>
                    <button type="button" class="btn-opcion" data-dias="30">Últimos 30 días</button>
                    <button type="button" class="btn-opcion" data-dias="90">Últimos 3 meses</button>
                    <button type="button" class="btn-opcion" data-dias="365">Último año</button>
                </div>
                <div class="botones-opciones" id="opcionesFuturo" style="display: none;">
                    <button type="button" class="btn-opcion" data-dias="7">Próximos 7 días</button>
                    <button type="button" class="btn-opcion" data-dias="30">Próximos 30 días</button>
                    <button type="button" class="btn-opcion" data-dias="60">Próximos 2 meses</button>
                    <button type="button" class="btn-opcion" data-dias="90">Próximos 3 meses</button>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" id="btnCancelar">Cancelar</button>
            <button class="btn btn-primary" id="btnAplicar">Aplicar Filtro</button>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'estadisticas/css/estadisticas.css' %}">
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="{% static 'estadisticas/js/estadisticas.js' %}"></script>
<script src="{% static 'estadisticas/js/charts.js' %}"></script>
{% endblock %}