<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Registrar Nuevo Usuario | Tienda Naturista</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary-green: #3A8C6E;
      --primary-blue: #3498B5;
      --white-base: #F9FCFA;
      --accent-green: #5CB85C;
      --soft-blue: #E6F4F8;
      --natural-gray: #7F8C8D;
      --dark-gray: #34495E;
    }

    * {
      box-sizing: border-box;
      font-family: "Poppins", sans-serif;
    }

    body {
      min-height: 100vh;
      background: var(--soft-blue);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .register-container {
      max-width: 700px;
      width: 100%;
      background: var(--white-base);
      border-radius: 16px;
      box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
      overflow: hidden;
    }

    .register-header {
      background: linear-gradient(135deg, var(--primary-green), var(--primary-blue));
      padding: 2rem;
      color: white;
      text-align: center;
      position: relative;
    }

    .register-header h2 {
      font-weight: 600;
      margin-bottom: 0.5rem;
    }

    .register-body {
      padding: 2rem;
    }

    .form-label {
      font-weight: 500;
      color: var(--dark-gray);
      margin-bottom: 0.4rem;
    }

    .form-control {
      padding: 14px 16px;
      border: 1px solid #ddd;
      border-radius: 10px;
      background-color: white;
      font-size: 1rem;
      color: var(--dark-gray);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      transition: all 0.3s ease;
    }

    .form-control:focus {
      border-color: var(--primary-green);
      box-shadow: 0 0 0 3px rgba(58, 140, 110, 0.15);
      outline: none;
    }

    .error-msg {
      color: #e74c3c;
      font-size: 0.85rem;
      margin-top: 0.3rem;
      font-weight: 500;
    }

    .success-msg {
      color: var(--accent-green);
      font-weight: 600;
      font-size: 1rem;
    }

    .btn-primary, .btn-secondary {
      border: none;
      border-radius: 10px;
      padding: 14px 20px;
      font-size: 1rem;
      font-weight: 600;
      display: block;
      width: 100%;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      text-decoration: none;
      text-align: center;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary-green), var(--primary-blue));
      color: white;
      margin-top: 1rem;
    }

    .btn-primary:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 16px rgba(58, 140, 110, 0.3);
      color: white;
    }

    .btn-secondary {
      background: var(--natural-gray);
      color: white;
      margin-top: 0.8rem;
    }

    .btn-secondary:hover {
      background: var(--dark-gray);
      transform: translateY(-2px);
      color: white;
    }

    .password-hint {
      font-size: 0.8rem;
      color: var(--natural-gray);
      margin-top: 0.25rem;
    }

    .password-match {
      color: var(--accent-green);
      font-weight: 500;
    }

    .password-mismatch {
      color: #e74c3c;
      font-weight: 500;
    }

    .password-requirements {
      font-size: 0.8rem;
      color: var(--natural-gray);
      margin-top: 0.25rem;
    }

    .password-valid {
      color: var(--accent-green);
    }

    .password-invalid {
      color: #e74c3c;
    }

    .password-container {
        position: relative;
    }
    
    .password-toggle {
        position: absolute;
        right: 15px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--natural-gray);
        cursor: pointer;
        z-index: 20; /* Higher than input */
        user-select: none;
    }
    
    .password-toggle:hover {
        color: var(--primary-green);
    }
    
    @media (max-width: 576px) {
      .register-body {
        padding: 1.5rem;
      }

      .register-header {
        padding: 1.5rem;
      }
    }
  </style>
</head>
<body>
<div class="register-container">
  <div class="register-header">
    <h2>Registrar Nuevo Usuario</h2>
    <p>Agrega un nuevo miembro al sistema</p>
  </div>

  <div class="register-body">
    <!-- Mostrar mensajes de error de Django -->
    {% if messages %}
      {% for message in messages %}
        {% if message.tags == 'error' %}
          <div class="error-msg mb-3 text-center">
            <i class="fas fa-exclamation-circle"></i> {{ message }}
          </div>
        {% endif %}
      {% endfor %}
    {% endif %}

    <form id="registroForm" method="POST" novalidate>
      {% csrf_token %}
      <div class="row g-4">
        <!-- Cédula y Fecha -->
        <div class="col-md-6">
          <label for="cedula" class="form-label">Cédula</label>
          <input type="text" id="cedula" name="cedula" class="form-control" value="{{ form.cedula.value|default_if_none:'' }}" required placeholder="Ej: 12345678">
          <div id="error-cedula" class="error-msg">{% for error in form.cedula.errors %}{{ error }}{% endfor %}</div>
        </div>

        <div class="col-md-6">
          <label for="fecha_nacimiento" class="form-label">Fecha de Nacimiento</label>
          <input type="date" id="fecha_nacimiento" name="fecha_nacimiento" class="form-control" value="{{ form.fecha_nacimiento.value|default_if_none:'' }}" required max="{% now 'Y-m-d' %}" onkeydown="return false">
          <div id="error-fecha" class="error-msg">{% for error in form.fecha_nacimiento.errors %}{{ error }}{% endfor %}</div>
        </div>

        <!-- Nombre y Apellido -->
        <div class="col-md-6">
          <label for="nombre" class="form-label">Nombre</label>
          <input type="text" id="nombre" name="first_name" class="form-control uppercase-input" value="{{ form.first_name.value|default_if_none:'' }}" required style="text-transform: uppercase;" maxlength="10" placeholder="NOMBRE">
          <div id="error-nombre" class="error-msg">{% for error in form.first_name.errors %}{{ error }}{% endfor %}</div>
        </div>

        <div class="col-md-6">
          <label for="apellido" class="form-label">Apellido</label>
          <input type="text" id="apellido" name="last_name" class="form-control uppercase-input" value="{{ form.last_name.value|default_if_none:'' }}" required style="text-transform: uppercase;" maxlength="10" placeholder="APELLIDO">
          <div id="error-apellido" class="error-msg">{% for error in form.last_name.errors %}{{ error }}{% endfor %}</div>
        </div>

        <!-- Email y Rol -->
        <div class="col-md-6">
          <label for="email" class="form-label">Correo electrónico</label>
          <input type="email" id="email" name="email" class="form-control" value="{{ form.email.value|default_if_none:'' }}" required placeholder="correo@ejemplo.com">
          <div id="error-email" class="error-msg">{% for error in form.email.errors %}{{ error }}{% endfor %}</div>
        </div>

        <div class="col-md-6">
          <label for="rol" class="form-label">Rol de Usuario</label>
          <select id="rol" name="rol" class="form-select" required>
            <option value="" disabled selected>Seleccione un rol</option>
            <option value="Administrador">Administrador</option>
            <option value="Cajero">Cajero</option>
            <!-- <option value="Bodeguero">Bodeguero</option> -->
          </select>
        </div>

        <!-- Contraseñas -->
        <div class="col-md-6">
          <label for="password1" class="form-label">Contraseña</label>
          <div class="password-container">
              <input type="password" id="password1" name="password1" class="form-control" required placeholder="Contraseña segura">
              <span class="password-toggle material-symbols-rounded" id="togglePassword1">visibility</span>
          </div>
          <div class="password-hint">Ejemplo: MiContraseña123!</div>
          <div id="password-requirements" class="password-requirements"></div>
          <div id="error-password1" class="error-msg">{% for error in form.password1.errors %}{{ error }}{% endfor %}</div>
        </div>

        <div class="col-md-6">
          <label for="password2" class="form-label">Confirmar Contraseña</label>
          <div class="password-container">
              <input type="password" id="password2" name="password2" class="form-control" required placeholder="Repite la contraseña">
              <span class="password-toggle material-symbols-rounded" id="togglePassword2">visibility</span>
          </div>
          <div id="password-match" class="password-hint"></div>
          <div id="error-password2" class="error-msg">{% for error in form.password2.errors %}{{ error }}{% endfor %}</div>
        </div>
      </div>

      {% if form.non_field_errors %}
        <div class="error-msg mt-3 text-center">{% for error in form.non_field_errors %}{{ error }}{% endfor %}</div>
      {% endif %}

      <div class="mt-5 d-flex gap-3 justify-content-center">
          <a href="{% url 'usuarios:menu_configuracion' %}" class="btn btn-secondary px-4 py-2">
            <i class="fas fa-arrow-left me-2"></i> Volver
          </a>
          <button type="submit" class="btn btn-primary px-5 py-2">
             <i class="fas fa-save me-2"></i> Registrar Usuario
          </button>
      </div>
    </form>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const form = document.getElementById('registroForm');
    const cedula = document.getElementById('cedula');
    const nombre = document.getElementById('nombre');
    const apellido = document.getElementById('apellido');
    const fechaNacimiento = document.getElementById('fecha_nacimiento');
    const email = document.getElementById('email');
    const password1Input = document.getElementById('password1');
    const password2Input = document.getElementById('password2');
    const passwordMatch = document.getElementById('password-match');
    const passwordRequirements = document.getElementById('password-requirements');
    
    // Toggle Password Visibility
    const togglePass1 = document.getElementById('togglePassword1');
    const togglePass2 = document.getElementById('togglePassword2');
    
    function setupToggle(toggleBtn, inputElem) {
        if(toggleBtn && inputElem) {
            toggleBtn.addEventListener('click', function() {
                const type = inputElem.getAttribute('type') === 'password' ? 'text' : 'password';
                inputElem.setAttribute('type', type);
                this.textContent = type === 'password' ? 'visibility' : 'visibility_off';
            });
        }
    }
    
    setupToggle(togglePass1, password1Input);
    setupToggle(togglePass2, password2Input);

    const errorCedula = document.getElementById('error-cedula');
    const errorNombre = document.getElementById('error-nombre');
    const errorApellido = document.getElementById('error-apellido');
    const errorFecha = document.getElementById('error-fecha');
    const errorEmail = document.getElementById('error-email');

    // Variables para controlar validación en tiempo real
    let emailTouched = false;
    let password1Touched = false;
    let password2Touched = false;

    // ===== CONVERSIÓN AUTOMÁTICA A MAYÚSCULAS =====
    function convertirAMayusculas(input) {
        input.addEventListener('input', function() {
            this.value = this.value.toUpperCase();
        });
    }

    // ===== VALIDACIONES EN TIEMPO REAL =====

    // Validación de cédula
    cedula.addEventListener('input', function (e) {
      this.value = this.value.replace(/[^0-9]/g, '').substring(0, 8);
      validarCedula();
    });

    // Convertir nombre y apellido a mayúsculas automáticamente
    convertirAMayusculas(nombre);
    convertirAMayusculas(apellido);

    // Validación de nombre (solo letras)
    nombre.addEventListener('input', function (e) {
      this.value = this.value.toUpperCase().slice(0, 10);
      this.value = this.value.replace(/[^a-zA-ZáéíóúÁÉÍÓÚñÑ\s]/g, '');
      validarNombre();
    });

    // Validación de apellido (solo letras)
    apellido.addEventListener('input', function (e) {
      this.value = this.value.toUpperCase().slice(0, 10);
      this.value = this.value.replace(/[^a-zA-ZáéíóúÁÉÍÓÚñÑ\s]/g, '');
      validarApellido();
    });

    // Validación de email en tiempo real
    email.addEventListener('input', function() {
      emailTouched = true;
      validarEmail();
    });

    // Validación de contraseñas en tiempo real
    password1Input.addEventListener('input', function() {
      password1Touched = true;
      validarFortalezaPassword();
      validarCoincidenciaPassword();
    });

    password2Input.addEventListener('input', function() {
      password2Touched = true;
      validarCoincidenciaPassword();
    });
    
    // Validación de fecha edad
    fechaNacimiento.addEventListener('change', validarEdad);

    function validarCedula() {
      const valor = cedula.value.trim();
      const soloNumeros = /^\d{7,8}$/;
      if (valor === '') {
        // No mostrar error si está vacío mientras escribe, solo al final
        return false; 
      }
      if (!soloNumeros.test(valor)) {
        errorCedula.textContent = "La cédula debe tener entre 7 y 8 dígitos numéricos.";
        return false;
      }
      errorCedula.textContent = "";
      return true;
    }

    function validarNombre() {
      const valor = nombre.value.trim();
      const soloLetras = /^[a-zA-ZáéíóúÁÉÍÓÚñÑ\s]+$/;
      
      if (valor === '') return false;
      
      if (valor.length < 3) {
          errorNombre.textContent = "El nombre debe tener al menos 3 letras.";
          return false;
      }
      if (!soloLetras.test(valor)) {
          errorNombre.textContent = "El nombre solo puede contener letras.";
          return false;
      }
      
      errorNombre.textContent = "";
      return true;
    }

    function validarApellido() {
      const valor = apellido.value.trim();
      const soloLetras = /^[a-zA-ZáéíóúÁÉÍÓÚñÑ\s]+$/;
      
      if (valor === '') return false;
      
      if (valor.length < 3) {
          errorApellido.textContent = "El apellido debe tener al menos 3 letras.";
          return false;
      }
       if (!soloLetras.test(valor)) {
          errorApellido.textContent = "El apellido solo puede contener letras.";
          return false;
      }
      
      errorApellido.textContent = "";
      return true;
    }

    function validarEmail() {
      const valor = email.value.trim();
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      
      if (valor === '') {
        if (emailTouched) errorEmail.textContent = "Este campo es obligatorio.";
        return false;
      }
      
      if (!emailRegex.test(valor)) {
        errorEmail.textContent = "Por favor, introduce un correo electrónico válido.";
        return false;
      }
      
      errorEmail.textContent = "";
      return true;
    }

    function validarFortalezaPassword() {
      const valor = password1Input.value;
      const requirements = {
        length: valor.length >= 8,
        uppercase: /[A-Z]/.test(valor),
        lowercase: /[a-z]/.test(valor),
        number: /\d/.test(valor),
        special: /[@$!%*?&]/.test(valor)
      };
      
      // Actualizar mensaje de requisitos
      let requirementsHtml = '';
      requirementsHtml += `<div class="${requirements.length ? 'password-valid' : 'password-invalid'}">✓ Al menos 8 caracteres</div>`;
      requirementsHtml += `<div class="${requirements.uppercase ? 'password-valid' : 'password-invalid'}">✓ Una letra mayúscula</div>`;
      requirementsHtml += `<div class="${requirements.lowercase ? 'password-valid' : 'password-invalid'}">✓ Una letra minúscula</div>`;
      requirementsHtml += `<div class="${requirements.number ? 'password-valid' : 'password-invalid'}">✓ Un número</div>`;
      requirementsHtml += `<div class="${requirements.special ? 'password-valid' : 'password-invalid'}">✓ Un carácter especial (@$!%*?&)</div>`;
      
      passwordRequirements.innerHTML = requirementsHtml;
      
      const allValid = Object.values(requirements).every(req => req);
      
      if (valor && !allValid) {
        if (password1Touched) {
          document.getElementById('error-password1').textContent = "La contraseña no cumple con todos los requisitos.";
        }
        return false;
      }
      
      document.getElementById('error-password1').textContent = "";
      return allValid;
    }

    function validarCoincidenciaPassword() {
      const pass1 = password1Input.value;
      const pass2 = password2Input.value;
      
      if (pass2 === '') {
        passwordMatch.textContent = "";
        return false;
      }
      
      if (pass1 !== pass2) {
        passwordMatch.textContent = "Las contraseñas no coinciden.";
        passwordMatch.className = "password-hint password-mismatch";
        return false;
      } else {
        passwordMatch.textContent = "Las contraseñas coinciden.";
        passwordMatch.className = "password-hint password-match";
        return true;
      }
    }

    function validarEdad() {
      if (!fechaNacimiento.value) return false;

      const fecha = new Date(fechaNacimiento.value);
      const hoy = new Date();
      let edad = hoy.getFullYear() - fecha.getFullYear();
      const mes = hoy.getMonth() - fecha.getMonth();
      const dia = hoy.getDate() - fecha.getDate();
      
      if (mes < 0 || (mes === 0 && dia < 0)) {
          edad--;
      }
      
      if (edad < 18) {
        errorFecha.textContent = "Debes ser mayor de 18 años.";
        return false;
      }
      
      errorFecha.textContent = "";
      return true;
    }

    // Validación de Rol en tiempo real
    const rolSelect = document.getElementById('rol');
    if (rolSelect) {
        rolSelect.addEventListener('change', function() {
            if (this.value === "") {
                this.classList.add('is-invalid');
                // Ensure error msg exists
                let errorSpan = this.nextElementSibling;
                if (!errorSpan || !errorSpan.classList.contains('error-msg')) {
                     errorSpan = document.createElement('div');
                     errorSpan.className = 'error-msg';
                     this.parentNode.insertBefore(errorSpan, this.nextSibling);
                }
                errorSpan.textContent = "Este campo es obligatorio.";
            } else {
                this.classList.remove('is-invalid');
                 let errorSpan = this.nextElementSibling;
                if (errorSpan && errorSpan.classList.contains('error-msg')) {
                     errorSpan.textContent = "";
                }
            }
        });
    }

    function validarRol() {
        if (!rolSelect) return true;
        if (rolSelect.value === "") {
             rolSelect.classList.add('is-invalid');
             let errorSpan = rolSelect.nextElementSibling;
            if (!errorSpan || !errorSpan.classList.contains('error-msg')) {
                    errorSpan = document.createElement('div');
                    errorSpan.className = 'error-msg';
                    rolSelect.parentNode.insertBefore(errorSpan, rolSelect.nextSibling);
            }
            errorSpan.textContent = "Este campo es obligatorio.";
            return false;
        }
        rolSelect.classList.remove('is-invalid');
        return true;
    }

    // Validación completa al enviar el formulario
    form.addEventListener('submit', function (e) {
      emailTouched = true;
      password1Touched = true;
      password2Touched = true;
      
      const esValido = 
        validarCedula() &&
        validarNombre() &&
        validarApellido() &&
        validarEdad() &&
        validarEmail() &&
        validarRol() && 
        validarFortalezaPassword() &&
        validarCoincidenciaPassword();

      if (!esValido) {
        e.preventDefault();
        const firstError = document.querySelector('.error-msg:not(:empty)');
        if (firstError) {
          const inputId = firstError.id ? firstError.id.replace('error-', '') : 'rol'; 
          const inputElement = document.getElementById(inputId === 'password' ? 'password1' : inputId);
          if (inputElement) {
            inputElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
            inputElement.focus();
          }
        }
      }
    });
  });
</script>
</body>
</html>